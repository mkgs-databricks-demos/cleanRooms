# This is a Databricks asset bundle definition for basic_clean_room.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
bundle:
  name: basic_clean_room
  uuid: ed8d3f59-9a92-4a96-a1fb-a8e3f8f6a0fe

include:
  - resources/*.yml
  - resources/*/*.yml

# sync:
#   exclude:
#     - src/*.lvdash.json
#     - src/*/*.lvdash.json

# Variable declarations. These variables are assigned in the dev/prod targets below.
variables:
  catalog:
    description: The catalog to use
  schema:
    description: The schema to use
    default: clean_room_sample_data
  run_as_user:
    description: The service principal name (application ID) or user email for which the workflows and pipelines should be run as. 
  higher_level_service_principal:
    description: The service principal name (application ID) for higher level deployments.  Comment this out if you are not using a service_principal for deployments above the dev target.
    default: 47c0365e-b1af-429c-b56d-07cfb18b5dc7
  style: 
    description: "Which type of clean room tasks should be run-- values are: [creator, collaborator]"
    default: collaborator
  serverless_environment_version:
    description: The serverless environment for which to run the workflows, notebook tasks, etc. 
    default: 4

targets:
  # this target may be altered to run in development mode, otherwise its primarily for matthew.giglia@databricks.com's updates.  To run the demo yourself, the recommendation is to use the creator or collab targets depending if you are the creator of the clean room, or an invited collaborator.  
  dev:
    mode: development
    default: true
    workspace:
      host: https://fe-vm-mkgs-databricks-demos.cloud.databricks.com/
      root_path: /Workspace/Users/${var.run_as_user}/.bundle/${bundle.name}/${bundle.target}
    resources:
      jobs:
        generate_clean_room_sample_data:
          run_as:
            user_name: ${var.run_as_user}
    variables:
      catalog: mkgs_dev
      schema: clean_room_sample_data
      run_as_user: matthew.giglia@databricks.com
      style: creator

# update the details for the creator or collab workspace as required for your workspace, catalog, schema and run_as_user 

  creator: 
    # the primary use of this target is to run the job that will create the clean room using the Databricks Python SDK.  Must have "create clean room" permission for the run as user to execute.  
    # Pre-req: 
      # create a workspace folder called "creator" at the path /Workspace/creator and ensure that the run-as user has read and write permissions to the folder.  The notebook code and deployement state files will be deployed here for the workflow to execute.  
      # to run as a service principal, create the service principal and capture its application id to use and set it in the defaults above or override below with higher_level_service_principal: <application_id>  
    mode: production
    default: false
    presets:
      name_prefix: "[creator] "
    workspace:
      host: https://fe-vm-mkgs-databricks-demos.cloud.databricks.com/
      root_path: /Workspace/creator/.bundle/${bundle.name}/${bundle.target}
    resources:
      jobs:
        generate_clean_room_sample_data:
          run_as:
            service_principal_name: ${var.run_as_user}
            # user_name: ${var.run_as_user}
    variables:
      catalog: mkgs
      schema: clean_room_sample_data
      run_as_user: ${var.higher_level_service_principal}
      # run_as_user: matthew.giglia@databricks.com
      style: creator

  # Pre-req: 
    # create a workspace folder called "collab" at the path /Workspace/collab and ensure that the run-as user has read and write permissions to the folder.  The notebook code and deployement state files will be deployed here for the workflows to execute. 
    # to run as a service principal, create the service principal and capture its application id to use and set it in the defaults above or override below with higher_level_service_principal: <application_id>  
  collab: 
    mode: production
    default: false
    presets:
      name_prefix: "[collab] "
    workspace:
      host: https://fe-vm-mkgs-databricks-demos.cloud.databricks.com/
      root_path: /Workspace/collab/.bundle/${bundle.name}/${bundle.target}
    resources:
      jobs:
        generate_clean_room_sample_data:
          run_as:
            service_principal_name: ${var.run_as_user}
            # user_name: ${var.run_as_user}
    variables:
      catalog: mkgs
      schema: clean_room_sample_data
      run_as_user: ${var.higher_level_service_principal}
      # run_as_user: matthew.giglia@databricks.com
      style: collaborator

