# This is a Databricks asset bundle definition for basic_clean_room.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
bundle:
  name: basic_clean_room
  uuid: ed8d3f59-9a92-4a96-a1fb-a8e3f8f6a0fe

include:
  - resources/*.yml
  - resources/*/*.yml

# sync:
#   exclude:
#     - src/*.lvdash.json
#     - src/*/*.lvdash.json

# Variable declarations. These variables are assigned in the dev/prod targets below.
variables:
  catalog:
    description: The catalog to use
  schema:
    description: The schema to use
    default: clean_room_sample_data
  run_as_user:
    description: The service principal name (application ID) or user email for which the workflows and pipelines should be run as. 
  higher_level_service_principal:
    description: The service principal name (application ID) for higher level deployments.  Comment this out if you are not using a service_principal for deployments above the dev target.
    default: 47c0365e-b1af-429c-b56d-07cfb18b5dc7
  style: 
    description: "Which type of clean room tasks should be run-- values are: [creator, collaborator]"
    default: collaborator
  serverless_environment_version:
    description: The serverless environment for which to run the workflows, notebook tasks, etc. 
    default: 4
  dashboard_embed_credentials:
    description: Set to true if the dashboard should use the owner's credentials, or false if the user's credentials should be used to run the dashboard and access Unity Catalog assets.  
    default: false

targets:
  # this target may be altered to run in development mode, otherwise its primarily for matthew.giglia@databricks.com's updates.  To run the demo yourself, the recommendation is to use the creator or collab targets depending if you are the creator of the clean room, or an invited collaborator.  
  dev:
    mode: development
    default: true
    workspace:
      host: https://fe-vm-mkgs-databricks-demos.cloud.databricks.com/
      root_path: /Workspace/Users/${var.run_as_user}/.bundle/${bundle.name}/${bundle.target}
    resources:
      jobs:
        generate_clean_room_sample_data:
          run_as:
            user_name: ${var.run_as_user}
      dashboards:
        clean_room_sample_data_bi:
          permissions:
            - user_name: ${var.run_as_user}
              level: CAN_MANAGE   
      sql_warehouses:
        aibi_warehouse:
          permissions:
            - user_name: ${var.run_as_user}
              level: CAN_MANAGE     
    variables:
      catalog: mkgs_dev
      schema: clean_room_sample_data
      run_as_user: matthew.giglia@databricks.com
      style: creator

# update the details for the creator or collab workspace as required for your workspace, catalog, schema and run_as_user.  recommended to create a service principal with use catalog and create schema on the target catalog like would be done in a production environment.  

  creator: 
    # the primary use of this target is to run the job that will create the clean room using the Databricks Python SDK.  Must have "create clean room" permission for the run as user to execute.  
    # Pre-req: 
      # - create a workspace folder called "creator" at the path /Workspace/creator and ensure that the run-as user has read and write permissions to the folder.  The notebook code and deployement state files will be deployed here for the workflow to execute.  
      # - to run as a service principal, create the service principal and capture its application id to use and set it in the defaults above or override below with higher_level_service_principal: <application_id>  
      # - if not using a service principal, comment out the resources: jobs: run_as: service_princial_name, and uncomment the one for user_name and adjust accordingly for your user name.  
    mode: production
    default: false
    presets:
      name_prefix: "[creator] "
    workspace:
      host: https://fe-vm-mkgs-databricks-demos.cloud.databricks.com/
      root_path: /Workspace/creator/.bundle/${bundle.name}/${bundle.target}
    resources:
      jobs:
        generate_clean_room_sample_data:
          run_as:
            service_principal_name: ${var.run_as_user}
            # user_name: ${var.run_as_user}
      dashboards:
        clean_room_sample_data_bi:
          permissions:
            - group_name:  account users
              level: CAN_READ
            - service_principal_name: ${var.run_as_user}
              level: CAN_MANAGE
            # - user_name: ${var.run_as_user}
            #   level: CAN_MANAGE  
      sql_warehouses:
        aibi_warehouse:
          permissions:
            - service_principal_name: ${var.run_as_user}
              level: CAN_MANAGE
            # - user_name: ${var.run_as_user}
            #   level: CAN_MANAGE
    variables:
      catalog: mkgs
      schema: clean_room_sample_data
      higher_level_service_principal: 47c0365e-b1af-429c-b56d-07cfb18b5dc7
      run_as_user: ${var.higher_level_service_principal}
      # run_as_user: matthew.giglia@databricks.com
      style: creator
      dashboard_embed_credentials: true

  # Pre-req: 
    # - create a workspace folder called "collab" at the path /Workspace/collab and ensure that the run-as user has read and write permissions to the folder.  The notebook code and deployement state files will be deployed here for the workflows to execute. 
    # - to run as a service principal, create the service principal and capture its application id to use and set it in the defaults above or override below with higher_level_service_principal: <application_id>  
    # - if not using a service principal, comment out the resources: jobs: run_as: service_princial_name, and uncomment the one for user_name and adjust accordingly for your user name.
  collab: 
    mode: production
    default: false
    presets:
      name_prefix: "[collab] "
    workspace:
      host: https://fe-vm-mkgs-databricks-demos.cloud.databricks.com/
      root_path: /Workspace/collab/.bundle/${bundle.name}/${bundle.target}
    resources:
      jobs:
        generate_clean_room_sample_data:
          run_as:
            service_principal_name: ${var.run_as_user}
            # user_name: ${var.run_as_user}
      dashboards:
        clean_room_sample_data_bi:
          permissions:
            - group_name:  account users
              level: CAN_READ
            - service_principal_name: ${var.run_as_user}
              level: CAN_MANAGE
            # - user_name: ${var.run_as_user}
            #   level: CAN_MANAGE  
      sql_warehouses:
        aibi_warehouse:
          permissions:
            - service_principal_name: ${var.run_as_user}
              level: CAN_MANAGE
            # - user_name: ${var.run_as_user}
            #   level: CAN_MANAGE
    variables:
      catalog: mkgs
      schema: clean_room_sample_data
      higher_level_service_principal: 47c0365e-b1af-429c-b56d-07cfb18b5dc7
      run_as_user: ${var.higher_level_service_principal}
      # run_as_user: matthew.giglia@databricks.com
      style: collaborator
      dashboard_embed_credentials: true

