resources:
  jobs:
    generate_clean_room_sample_data:
      name: Basic Clean Room - Generate Sample Data
      
      description: A one time run job to generate some sample health care data to use in a clean room demo.  The notebook generates a star schema with a visits table, plus dimensions for patient, provider, and diagnosis.  

      parameters:
        - name: catalog_use
          default: ${var.catalog}
        - name: schema_use
          default: ${resources.schemas.basic_clean_room_schema.name}

      environments:
        - environment_key: primary
          spec:
            environment_version: ${var.serverless_environment_version}
        - environment_key: vector_search
          spec:
            environment_version: ${var.serverless_environment_version}
            dependencies: [databricks-vectorsearch]

      tasks:
        - task_key: generate_sample_data
          notebook_task:
            notebook_path: ../src/sample_data_generation/create sample data.ipynb
            source: WORKSPACE
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: primary

        - task_key: metric_veiws
          depends_on: 
            - task_key: generate_sample_data
          notebook_task:
            notebook_path: ../src/sample_data_generation/create metric views.ipynb
            source: WORKSPACE
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: primary

        - task_key: refresh_dashboard
          depends_on:
            - task_key: metric_veiws
          run_job_task:
            job_id: ${resources.dashboards.clean_room_sample_data_bi.id}
          max_retries: 1

        

